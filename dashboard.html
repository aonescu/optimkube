<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kubernetes Cost Optimizer Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.2);
        }

        .card h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .metric-label {
            color: #718096;
            font-size: 0.9rem;
        }

        .savings {
            color: #38a169;
        }

        .cost {
            color: #e53e3e;
        }

        .waste {
            color: #d69e2e;
        }

        .chart-container {
            grid-column: 1 / -1;
            height: 400px;
            position: relative;
        }

        .recommendations {
            grid-column: 1 / -1;
        }

        .recommendation-item {
            background: rgba(255,255,255,0.8);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #4299e1;
            transition: all 0.3s ease;
        }

        .recommendation-item:hover {
            background: rgba(255,255,255,0.95);
            transform: translateX(5px);
        }

        .recommendation-title {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .recommendation-description {
            color: #4a5568;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .recommendation-savings {
            color: #38a169;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .priority-high {
            border-left-color: #e53e3e;
        }

        .priority-medium {
            border-left-color: #d69e2e;
        }

        .priority-low {
            border-left-color: #38a169;
        }

        .loading {
            text-align: center;
            color: #718096;
            font-style: italic;
        }

        .error {
            color: #e53e3e;
            text-align: center;
            padding: 20px;
            background: rgba(254, 226, 226, 0.8);
            border-radius: 10px;
            margin: 20px 0;
        }

        .refresh-btn {
            background: linear-gradient(45deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3);
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 153, 225, 0.4);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-healthy {
            background: #38a169;
            box-shadow: 0 0 10px rgba(56, 161, 105, 0.5);
        }

        .namespace-costs {
            max-height: 300px;
            overflow-y: auto;
        }

        .namespace-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .namespace-item:last-child {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .metric-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Kubernetes Cost Optimizer</h1>
            <p>Real-time cost analysis and optimization recommendations</p>
        </div>

        <button class="refresh-btn" onclick="loadDashboard()">üîÑ Refresh Data</button>

        <div class="dashboard-grid" id="dashboard">
            <div class="card">
                <div class="loading">Loading dashboard data...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let costSummary = null;
        let recommendations = [];
        let nodeMetrics = [];

        async function fetchData(endpoint) {
            try {
                const response = await fetch(`${API_BASE}/api/${endpoint}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${endpoint}:`, error);
                throw error;
            }
        }

        async function loadDashboard() {
            try {
                document.getElementById('dashboard').innerHTML = '<div class="card"><div class="loading">Loading dashboard data...</div></div>';
                
                // Fetch all data concurrently
                const [summary, recs, nodes] = await Promise.all([
                    fetchData('cost-summary'),
                    fetchData('recommendations'),
                    fetchData('metrics/nodes')
                ]);

                costSummary = summary;
                recommendations = recs;
                nodeMetrics = nodes;

                renderDashboard();
            } catch (error) {
                document.getElementById('dashboard').innerHTML = `
                    <div class="card">
                        <div class="error">
                            ‚ùå Failed to load dashboard data: ${error.message}
                            <br><br>
                            Make sure the Cost Optimizer service is running and accessible.
                        </div>
                    </div>
                `;
            }
        }

        function renderDashboard() {
            const dashboard = document.getElementById('dashboard');
            
            dashboard.innerHTML = `
                <!-- Cost Summary Cards -->
                <div class="card">
                    <h3><span class="status-indicator status-healthy"></span>Total Monthly Cost</h3>
                    <div class="metric-value cost">$${costSummary.total_monthly_cost.toFixed(2)}</div>
                    <div class="metric-label">Cluster-wide expenses</div>
                </div>

                <div class="card">
                    <h3>üí∞ Potential Savings</h3>
                    <div class="metric-value savings">$${costSummary.potential_savings.toFixed(2)}</div>
                    <div class="metric-label">${((costSummary.potential_savings / costSummary.total_monthly_cost) * 100).toFixed(1)}% reduction possible</div>
                </div>

                <div class="card">
                    <h3>‚ö†Ô∏è Wasted Resources</h3>
                    <div class="metric-value waste">$${costSummary.wasted_resources.toFixed(2)}</div>
                    <div class="metric-label">Underutilized capacity</div>
                </div>

                <div class="card">
                    <h3>üñ•Ô∏è Infrastructure</h3>
                    <div class="metric-value">${costSummary.node_count}</div>
                    <div class="metric-label">nodes ‚Ä¢ ${costSummary.pod_count} pods</div>
                </div>

                <div class="card">
                    <h3>üìä Recommendations</h3>
                    <div class="metric-value">${costSummary.recommendation_count}</div>
                    <div class="metric-label">optimization opportunities</div>
                </div>

                <div class="card">
                    <h3>üíæ Storage Cost</h3>
                    <div class="metric-value cost">${costSummary.storage_cost.toFixed(2)}</div>
                    <div class="metric-label">persistent volumes</div>
                </div>

                <!-- Cost Breakdown Chart -->
                <div class="card chart-container">
                    <h3>üìà Cost Breakdown</h3>
                    <canvas id="costChart"></canvas>
                </div>

                <!-- Node Utilization Chart -->
                <div class="card chart-container">
                    <h3>üñ•Ô∏è Node Utilization</h3>
                    <canvas id="nodeChart"></canvas>
                </div>

                <!-- Namespace Costs -->
                <div class="card">
                    <h3>üìÅ Namespace Costs</h3>
                    <div class="namespace-costs">
                        ${Object.entries(costSummary.namespace_costs)
                            .sort(([,a], [,b]) => b - a)
                            .map(([namespace, cost]) => `
                                <div class="namespace-item">
                                    <span>${namespace}</span>
                                    <span class="cost">${cost.toFixed(2)}</span>
                                </div>
                            `).join('')}
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="card recommendations">
                    <h3>üí° Optimization Recommendations</h3>
                    ${recommendations.length === 0 ? 
                        '<div class="loading">No recommendations available</div>' :
                        recommendations
                            .sort((a, b) => {
                                const priorityOrder = { high: 3, medium: 2, low: 1 };
                                return priorityOrder[b.priority] - priorityOrder[a.priority];
                            })
                            .slice(0, 10)
                            .map(rec => `
                                <div class="recommendation-item priority-${rec.priority}">
                                    <div class="recommendation-title">
                                        ${rec.type.replace(/_/g, ' ').toUpperCase()} - ${rec.resource}
                                    </div>
                                    <div class="recommendation-description">${rec.description}</div>
                                    <div class="recommendation-savings">
                                        üí∞ Potential savings: ${rec.potential_savings.toFixed(2)}/month
                                        ‚Ä¢ Priority: ${rec.priority.toUpperCase()}
                                    </div>
                                </div>
                            `).join('')
                    }
                </div>
            `;

            // Render charts after DOM is updated
            setTimeout(() => {
                renderCostChart();
                renderNodeChart();
            }, 100);
        }

        function renderCostChart() {
            const ctx = document.getElementById('costChart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Compute Cost', 'Storage Cost', 'Wasted Resources'],
                    datasets: [{
                        data: [
                            costSummary.compute_cost - costSummary.wasted_resources,
                            costSummary.storage_cost,
                            costSummary.wasted_resources
                        ],
                        backgroundColor: [
                            '#4299e1',
                            '#38a169',
                            '#d69e2e'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderNodeChart() {
            const ctx = document.getElementById('nodeChart');
            if (!ctx || nodeMetrics.length === 0) return;

            const sortedNodes = nodeMetrics
                .sort((a, b) => b.estimated_cost - a.estimated_cost)
                .slice(0, 10);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedNodes.map(node => node.name.length > 15 ? 
                        node.name.substring(0, 15) + '...' : node.name),
                    datasets: [
                        {
                            label: 'CPU Utilization (%)',
                            data: sortedNodes.map(node => node.cpu_utilization),
                            backgroundColor: 'rgba(66, 153, 225, 0.7)',
                            borderColor: 'rgba(66, 153, 225, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Memory Utilization (%)',
                            data: sortedNodes.map(node => node.memory_utilization),
                            backgroundColor: 'rgba(56, 161, 105, 0.7)',
                            borderColor: 'rgba(56, 161, 105, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Monthly Cost ($)',
                            data: sortedNodes.map(node => node.estimated_cost),
                            type: 'line',
                            backgroundColor: 'rgba(214, 158, 46, 0.2)',
                            borderColor: 'rgba(214, 158, 46, 1)',
                            borderWidth: 2,
                            fill: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Nodes'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Utilization (%)'
                            },
                            max: 100
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Cost ($)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const nodeIndex = context.dataIndex;
                                    const node = sortedNodes[nodeIndex];
                                    return [
                                        `Instance Type: ${node.instance_type}`,
                                        `CPU: ${node.cpu_usage.toFixed(2)}/${node.cpu_capacity.toFixed(2)} cores`,
                                        `Memory: ${node.memory_usage.toFixed(2)}/${node.memory_capacity.toFixed(2)} GB`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        // Auto-refresh every 5 minutes
        setInterval(loadDashboard, 5 * 60 * 1000);

        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', loadDashboard);